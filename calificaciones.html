<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte por RA - Ing. Abreu</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .header-ra {
            background-color: #e9f5ff !important;
            color: #004d40;
            font-weight: bold;
            text-align: left !important;
            padding-left: 20px !important;
        }
        .btn-periodo {
            flex: 1; padding: 10px; background-color: #004d40; color: white;
            border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .btn-periodo:hover { background-color: #00796b; }
    </style>
</head>
<body>

 <header class="navbar">
    <div class="navbar-content">
        <div class="logo"><a href="index.html">J. L. Abreu | Portafolio Docente</a></div>
        <nav>
            <ul class="nav-links">
                <li><a href="index.html">Inicio</a></li>
                <li class="dropdown">
                    <a href="#">Módulos</a>
                    <ul class="submenu">
                        <li><a href="DDBD.html">DDBD</a></li>
                        <li><a href="DPWRM.html">DPWRM</a></li>
                        <li><a href="TecDig.html">Tec.Dig</a></li>
                        <li><a href="DASI.html">DASI</a></li>
                        <li><a href="IMASI.html">IMASI</a></li>
                        <li><a href="Talleres.html">Talleres</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#">Herramientas</a>
                    <ul class="submenu">
                        <li><a href="Horario.html">Horario</a></li>
                        <li><a href="gestion_actividad.html">Actividades</a></li>
                        <li><a href="ruleta.html">Ruleta</a></li>
						<li><a href="Preguntas.html">Ruleta de Preguntas</a></li>
						<li><a href="Planificacion-Diaria.html">Planificación Diaria</a></li>	
						<li><a href="calificaciones.html">Calificaciones</a></li>					
						<li><a href="https://juanapau.github.io/Sistema-UGC/incidencias-maestros.html " target="_blank" rel="noopener noreferrer">Reportes Gestión de la Convivencia</a></li>
						<li><a href="incidencias.html" target="_blank" rel="noopener noreferrer">Incidencias y Diario Reflexivo</a></li>								
                    </ul>
                </li>
				<li><a href="http://profejorgeabreu.ddns.net/" target="_blank" rel="noopener noreferrer">Estudiantes</a></li>	
                <li><a href="cv_soporte.html">CV/Soporte</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="container">
    <h1>Consulta de Calificaciones</h1>
    <div class="metadata">Ing. Jorge Luis Abreu - Reporte Agrupado por RA</div>

    <div class="content-box">
        <div class="cv-section">
            <div style="flex: 1;">
                <label for="asignaturaSelect"><b>Asignatura y Curso:</b></label>
                <select id="asignaturaSelect" class="cargar-div" style="width: 100%;">
                    <option value="">-- Seleccionar --</option>
                    <option value="Tecnologia Digital|4to C">Tecnología Digital - 4to C</option>
                    <option value="DPWRM|4to B">DPWRM - 4to B</option>
                    <option value="DDBD|4to B">DDBD - 4to B</option>
                    <option value="DASI|5to B">DASI - 5to B</option>
                    <option value="IMASI|6to B">IMASI - 6to B</option>
                    <option value="Taller|3ro A">Taller - 3ro A</option>
                    <option value="Taller|3ro B">Taller - 3ro B</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label><b>Seleccionar Período:</b></label>
                <div id="period-tabs" style="display: flex; gap: 8px; margin-top: 10px;">
                    <button type="button" class="btn-periodo" onclick="consultar('P1')">P1</button>
                    <button type="button" class="btn-periodo" onclick="consultar('P2')">P2</button>
                    <button type="button" class="btn-periodo" onclick="consultar('P3')">P3</button>
                    <button type="button" class="btn-periodo" onclick="consultar('P4')">P4</button>
                </div>
            </div>
        </div>
    </div>

    <div id="resultados-tabla-section">
        <h2 id="titulo-reporte">Reporte Académico</h2>
        <div class="table-responsive-container">
            <table id="resultados-tabla" class="horario-clases">
                <thead>
                    <tr>
                        <th>Estudiante</th>
                        <th>Mínimo RA</th>
                        <th>Nota</th>
                        <th>REC</th>
                        <th>Nota Final</th>
                    </tr>
                </thead>
                <tbody id="tabla-body">
                    <tr><td colspan="5">Seleccione los filtros para consultar.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwuToYCtCxnhxaURPI_FJFahJ0ldeK0USsruwQgamiuRHeTY6Jx2PIuBIccAT-qSKCO/exec";
    let baseDatos = [];

    async function cargarDatos() {
        try {
            const response = await fetch(WEB_APP_URL);
            baseDatos = await response.json();
            console.log("Datos sincronizados.");
        } catch (e) {
            console.error("Error de conexión.");
        }
    }

    function consultar(periodo) {
        const seleccion = document.getElementById('asignaturaSelect').value;
        if (!seleccion) return alert("Seleccione Asignatura");

        const [materia, curso] = seleccion.split('|');
        const tbody = document.getElementById('tabla-body');
        tbody.innerHTML = "";
        document.getElementById('titulo-reporte').innerText = `${materia} - ${curso} (${periodo})`;

        // 1. Filtrar datos iniciales
        const filtrados = baseDatos.filter(f => 
            f.Asignatura.toString().trim().toUpperCase() === materia.toUpperCase() &&
            f.Curso.toString().trim().toUpperCase() === curso.toUpperCase() &&
            f.Periodo.toString().trim().toUpperCase() === periodo.toUpperCase() &&
            f.Calificacion !== ""
        );

        if (filtrados.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5'>No hay datos registrados.</td></tr>";
            return;
        }

        // 2. AGRUPAR POR RA
        const grupos = filtrados.reduce((acc, item) => {
            const ra = item.RA || "General";
            if (!acc[ra]) acc[ra] = [];
            acc[ra].push(item);
            return acc;
        }, {});

        // 3. RENDERIZAR GRUPOS
        for (const ra in grupos) {
            // Fila de encabezado de RA
            const trHead = document.createElement('tr');
            trHead.innerHTML = `<td colspan="5" class="header-ra">RESULTADO DE APRENDIZAJE: ${ra}</td>`;
            tbody.appendChild(trHead);

            grupos[ra].forEach(item => {
                const tr = document.createElement('tr');
                const nOriginal = parseFloat(item.Calificacion) || 0;
                const nRec = item.CalificacionREC ? parseFloat(item.CalificacionREC) : null;
                const nMinimo = parseFloat(item.MinimoRA) || 70;
                
                const nFinal = nRec !== null ? nRec : nOriginal;
                const esAprobado = nFinal >= nMinimo;
                const claseColor = esAprobado ? "acierto-txt" : "error-txt";

                tr.innerHTML = `
                    <td>${item.Estudiante}</td>
                    <td>${nMinimo}</td>
                    <td>${nOriginal}</td>
                    <td>${nRec || '-'}</td>
                    <td class="${claseColor}">${nFinal} ${esAprobado ? '✓' : '✗'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    cargarDatos();
</script>
	    <footer>
        <p>&copy; 2026 Jorge Luis Abreu Rodríguez | Portafolio Docente - C.E. Nuestra Señora de la Altagracia</p>
    </footer>
</body>
</html>

